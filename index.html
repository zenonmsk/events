<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh Xem Th∆∞ M·ª•c Google Drive C√¥ng Khai</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C·∫•u h√¨nh Font v√† giao di·ªán chung -->
    <style>
        :root {
            --primary-color: #EA4335; /* Google Red */
            --secondary-color: #4285F4; /* Google Blue */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .file-box {
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 150px;
        }
        .file-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        .placeholder {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.875rem;
            text-align: center;
            height: 100px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style cho Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content-wrapper {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        .modal-content-wrapper img, .modal-content-wrapper iframe {
            display: block;
            margin: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        .close-button {
            position: absolute;
            top: -30px;
            right: 0px;
            background: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-start justify-center">

    <!-- Th·∫ª ch·ª©a ch√≠nh (Main Container Card) -->
    <div class="container-card w-full max-w-4xl bg-white rounded-xl p-6 md:p-10 mt-10">
        <h1 class="text-3xl font-bold text-center mb-6 text-[var(--primary-color)]">
            Tr√¨nh Xem Th∆∞ M·ª•c Google Drive C√¥ng Khai
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Nh·∫≠p li√™n k·∫øt chia s·∫ª c√¥ng khai (Public Viewer) c·ªßa th∆∞ m·ª•c t·ª´ Google Drive.
        </p>

        <!-- Khu v·ª±c Nh·∫≠p li·ªáu -->
        <div class="space-y-4">
            <input type="text" id="driveUrlInput" placeholder="D√°n link Google Drive Folder (v√≠ d·ª•: https://drive.google.com/drive/folders/FOLDER_ID)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--secondary-color)] focus:border-[var(--secondary-color)]">
            
            <button id="processButton"
                    class="w-full bg-[var(--secondary-color)] text-white font-semibold py-3 rounded-lg hover:bg-opacity-90 transition duration-150 shadow-md flex items-center justify-center">
                <span id="buttonText">L·∫•y N·ªôi Dung Th∆∞ M·ª•c</span>
                <div id="loadingSpinner" class="loading-spinner ml-3 hidden"></div>
            </button>
        </div>

        <!-- Khu v·ª±c Hi·ªÉn th·ªã K·∫øt qu·∫£ -->
        <div id="resultContainer" class="mt-10 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">C√°c File trong Th∆∞ m·ª•c:</h2>
            
            <p id="apiKeyWarning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-md text-sm">
                ‚ö†Ô∏è **C·∫ßn API Key:** B·∫°n ph·∫£i thay `YOUR_GOOGLE_DRIVE_API_KEY_HERE` trong m√£ JS b·∫±ng Google Drive API Key th·ª±c t·∫ø c·ªßa b·∫°n ƒë·ªÉ ch·ª©c nƒÉng n√†y ho·∫°t ƒë·ªông.
            </p>

            <div id="fileGrid" 
                 class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- N·ªôi dung file s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
            </div>
            
            <p id="errorFeedback" class="text-red-500 mt-4 hidden text-center font-medium"></p>
        </div>

    </div>

    <!-- Modal Xem tr∆∞·ªõc (Lightbox) -->
    <div id="previewModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div id="modalContentWrapper" class="modal-content-wrapper">
            <button class="close-button" onclick="closeModal(event)">&times;</button>
            <div id="previewContent" class="h-full w-full">
                <!-- N·ªôi dung xem tr∆∞·ªõc (·∫¢nh ho·∫∑c Iframe Video) -->
            </div>
        </div>
    </div>

    <!-- Logic JavaScript -->
    <script type="module">
        // Khai b√°o bi·∫øn to√†n c·ª•c (Global variables required by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Thi·∫øt l·∫≠p API Key. B·∫†N C·∫¶N THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG API KEY TH·ª∞C T·∫æ C·ª¶A M√åNH.
        const GOOGLE_DRIVE_API_KEY = "AIzaSyC8DDxSNLSupebbcxEitkt279pvHj2ugzA";

        // C√°c ph·∫ßn t·ª≠ DOM
        const driveUrlInput = document.getElementById('driveUrlInput');
        const processButton = document.getElementById('processButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const fileGrid = document.getElementById('fileGrid');
        const errorFeedback = document.getElementById('errorFeedback');
        const apiKeyWarning = document.getElementById('apiKeyWarning');
        
        // Modal DOM Elements
        const previewModal = document.getElementById('previewModal');
        const previewContent = document.getElementById('previewContent');
        const modalContentWrapper = document.getElementById('modalContentWrapper');


        /**
         * Tr√≠ch xu·∫•t ID t·ª´ URL Google Drive (h·ª£p l·ªá cho c·∫£ File v√† Folder).
         * @param {string} url - URL Google Drive
         * @returns {string|null} - ID File/Folder ho·∫∑c null n·∫øu kh√¥ng t√¨m th·∫•y
         */
        function extractId(url) {
            // Regex t√¨m chu·ªói ID d√†i (th∆∞·ªùng l√† 25-40 k√Ω t·ª±)
            const regex = /[-\w]{25,}/; 
            const match = url.match(regex);
            
            if (match) {
                return match[0];
            }
            return null;
        }

        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o l·ªói.
         * @param {string} message - Th√¥ng b√°o l·ªói.
         */
        function displayError(message) {
            resultContainer.classList.remove('hidden');
            errorFeedback.textContent = message;
            errorFeedback.classList.remove('hidden');
            fileGrid.innerHTML = ''; // X√≥a grid c≈©
        }

        /**
         * Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
         * @param {boolean} isLoading - True ƒë·ªÉ hi·ªÉn th·ªã, False ƒë·ªÉ ·∫©n
         */
        function setLoadingState(isLoading) {
            processButton.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'ƒêang t·∫£i...';
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'L·∫•y N·ªôi Dung Th∆∞ M·ª•c';
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Th·ª±c hi·ªán l·ªánh g·ªçi Google Drive API ƒë·ªÉ l·∫•y danh s√°ch file trong th∆∞ m·ª•c.
         * @param {string} folderId - ID c·ªßa th∆∞ m·ª•c Google Drive.
         * @param {string} apiKey - Google Drive API Key.
         * @returns {Array} - M·∫£ng ch·ª©a th√¥ng tin c√°c file.
         */
        async function fetchFolderContents(folderId, apiKey) {
            if (apiKey === "YOUR_GOOGLE_DRIVE_API_KEY_HERE" || !apiKey) {
                displayError("L·ªói: Vui l√≤ng thay 'YOUR_GOOGLE_DRIVE_API_KEY_HERE' b·∫±ng Google Drive API Key th·ª±c t·∫ø. aa");
                return null;
            }

            // Tham s·ªë truy v·∫•n: q='folderId' in parents AND trashed=false
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed=false&fields=files(id,name,mimeType)&key=${apiKey}&pageSize=100`;
            
            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `L·ªói API (${response.status}).`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` Chi ti·∫øt: ${errorData.error.message}.`;
                    }
                    displayError(errorMessage + " ƒê·∫£m b·∫£o folder c√¥ng khai v√† API Key h·ª£p l·ªá.");
                    return null;
                }

                const data = await response.json();
                return data.files || [];

            } catch (error) {
                console.error("L·ªói k·∫øt n·ªëi m·∫°ng:", error);
                displayError('L·ªói k·∫øt n·ªëi m·∫°ng ho·∫∑c truy v·∫•n API th·∫•t b·∫°i.');
                return null;
            }
        }
        
        /**
         * M·ªü modal xem tr∆∞·ªõc v·ªõi n·ªôi dung t∆∞∆°ng ·ª©ng.
         * @param {string} fileId - ID c·ªßa file.
         * @param {string} mimeType - MIME type c·ªßa file.
         * @param {string} fileName - T√™n file.
         */
        function openPreview(fileId, mimeType, fileName) {
            previewContent.innerHTML = '';
            modalContentWrapper.style.width = 'auto'; // Reset width
            modalContentWrapper.style.height = 'auto'; // Reset height

            let contentHTML = '';
            const isImage = mimeType.startsWith('image/');
            const isVideo = mimeType.startsWith('video/');

            if (isImage) {
                // // ƒê√É S·ª¨A: Thay ƒë·ªïi t·ª´ export=view sang export=download ƒë·ªÉ tƒÉng kh·∫£ nƒÉng nh√∫ng ·∫£nh tr·ª±c ti·∫øp
                // const imageUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                // console.log(imageUrl)
                // contentHTML = `<img src="${imageUrl}" alt="${fileName}" class="max-w-full max-h-[85vh]">`;
                // ƒê√É S·ª¨A: S·ª≠ d·ª•ng iframe v√† link preview ƒë·ªÉ tr√°nh l·ªói ch·∫∑n nh√∫ng (CORS/Security Policy)
                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                // S·ª≠ d·ª•ng 100% chi·ªÅu r·ªông/cao c·ªßa modal ƒë·ªÉ ƒë·∫£m b·∫£o ·∫£nh hi·ªÉn th·ªã l·ªõn
                                contentHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameb                r="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                
                            // M·ªü r·ªông Modal cho ph√π h·ª£p v·ªõi n·ªôi dung nh√∫ng
                modalContentWrapper.style.width = '90vw'; 
                modalContentWrapper.style.height = '90vh';
        } else if (isVideo) {
                // Link nh√∫ng video
                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                // ƒê·∫∑t k√≠ch th∆∞·ªõc c·ªë ƒë·ªãnh cho iframe ƒë·ªÉ hi·ªÉn th·ªã t·ªët tr√™n modal
                contentHTML = `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" frameborder="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                modalContentWrapper.style.width = '800px';
                modalContentWrapper.style.height = '450px';

            } else {
                // ƒê·ªëi v·ªõi c√°c file kh√°c (v√≠ d·ª•: PDF, T√†i li·ªáu), m·ªü trong tab m·ªõi (fallback)
                const fileViewUrl = `https://drive.google.com/file/d/${fileId}/view`;
                window.location.href = fileViewUrl;
                return; 
            }

            previewContent.innerHTML = contentHTML;
            previewModal.classList.remove('hidden');
            // Th√™m class ƒë·ªÉ ngƒÉn cu·ªôn trang ch√≠nh
            document.body.classList.add('overflow-hidden');
        }

        /**
         * ƒê√≥ng modal xem tr∆∞·ªõc.
         */
        window.closeModal = function(event) {
            // NgƒÉn ch·∫∑n ƒë√≥ng modal n·∫øu click v√†o n·ªôi dung b√™n trong modal
            if (event && event.target !== previewModal && event.target.className !== 'close-button') {
                // N·∫øu click v√†o wrapper nh∆∞ng kh√¥ng ph·∫£i ch√≠nh modal (modal-overlay) ho·∫∑c n√∫t ƒë√≥ng, th√¨ kh√¥ng ƒë√≥ng
                if (event.target.closest('#modalContentWrapper') && event.target !== previewModal) return;
            }
            previewModal.classList.add('hidden');
            // G·ª° b·ªè class ngƒÉn cu·ªôn trang ch√≠nh
            document.body.classList.remove('overflow-hidden');
            previewContent.innerHTML = ''; // X√≥a n·ªôi dung ƒë·ªÉ d·ª´ng video/audio
        }
        
        /**
         * T·∫°o v√† hi·ªÉn th·ªã m·ªôt √¥ file (thumbnail) trong l∆∞·ªõi.
         * @param {Object} file - ƒê·ªëi t∆∞·ª£ng file t·ª´ API.
         */
        function displayFile(file) {
            let thumbnailContent;
            const isImageOrVideo = file.mimeType.startsWith('image/') || file.mimeType.startsWith('video/');

            if (isImageOrVideo) {
                const thumbnailSrc = `https://drive.google.com/thumbnail?id=${file.id}&sz=w150-h150-p`;

                const imgElement = document.createElement('img');
                imgElement.src = thumbnailSrc;
                imgElement.alt = file.name;
                imgElement.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'mx-auto', 'border', 'border-gray-200');
                
                imgElement.onerror = () => {
                    imgElement.outerHTML = `<div class="placeholder h-24 rounded-lg">File ƒëa ph∆∞∆°ng ti·ªán</div>`;
                };
                thumbnailContent = imgElement;
            } else {
                const icon = file.mimeType.includes('pdf') ? 'üìÑ' : 
                             file.mimeType.includes('document') ? 'üìù' : 
                             file.mimeType.includes('spreadsheet') ? 'üìä' : 
                             file.mimeType.includes('folder') ? 'üìÅ' : 'üì¶';
                
                thumbnailContent = document.createElement('div');
                thumbnailContent.classList.add('placeholder', 'h-24', 'rounded-lg');
                thumbnailContent.innerHTML = `<span class="text-3xl">${icon}</span><br><span class="text-xs">(${file.mimeType.split('/').pop()})</span>`;
            }

            const fileItem = document.createElement('div');
            fileItem.classList.add('file-box', 'bg-white', 'border', 'border-gray-300', 'rounded-xl', 'p-2', 'text-center', 'flex', 'flex-col', 'justify-between');
            
            const thumbnailWrapper = document.createElement('div');
            thumbnailWrapper.classList.add('mb-2');
            thumbnailWrapper.appendChild(thumbnailContent);
            fileItem.appendChild(thumbnailWrapper);

            const nameElement = document.createElement('p');
            nameElement.textContent = file.name;
            nameElement.classList.add('text-sm', 'font-medium', 'text-gray-800', 'truncate', 'mt-auto');
            fileItem.appendChild(nameElement);

            // X·ª≠ l√Ω s·ª± ki·ªán click
            fileItem.onclick = () => {
                if (isImageOrVideo) {
                    // M·ªü Preview Modal
                    openPreview(file.id, file.mimeType, file.name);
                } else {
                    // M·ªü trong tab m·ªõi cho c√°c file kh√¥ng ph·∫£i ·∫£nh/video
                    const fileViewUrl = `https://drive.google.com/file/d/${file.id}/view`;
                    window.location.href = fileViewUrl;
                }
            };

            fileGrid.appendChild(fileItem);
        }

        /**
         * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫•p v√†o n√∫t "L·∫•y N·ªôi Dung Th∆∞ M·ª•c".
         */
        async function handleProcess() {
            const url = driveUrlInput.value.trim();
            fileGrid.innerHTML = '';
            errorFeedback.classList.add('hidden');
            resultContainer.classList.add('hidden');
            apiKeyWarning.classList.remove('hidden'); 

            if (!url) {
                displayError('Vui l√≤ng nh·∫≠p m·ªôt li√™n k·∫øt Google Drive Folder.');
                return;
            }

            const folderId = extractId(url);

            if (!folderId) {
                displayError('Kh√¥ng t√¨m th·∫•y ID th∆∞ m·ª•c h·ª£p l·ªá trong li√™n k·∫øt. Vui l√≤ng ki·ªÉm tra l·∫°i li√™n k·∫øt chia s·∫ª.');
                return;
            }

            setLoadingState(true);
            resultContainer.classList.remove('hidden');

            const files = await fetchFolderContents(folderId, GOOGLE_DRIVE_API_KEY);

            setLoadingState(false);

            if (files && files.length > 0) {
                errorFeedback.classList.add('hidden');
                files.forEach(displayFile);
            } else if (files !== null) {
                displayError('Th∆∞ m·ª•c r·ªóng ho·∫∑c kh√¥ng t√¨m th·∫•y file n√†o ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.');
            }
        }

        // G√°n s·ª± ki·ªán cho n√∫t
        processButton.addEventListener('click', handleProcess);

        // Cho ph√©p nh·∫•n Enter trong √¥ input ƒë·ªÉ x·ª≠ l√Ω
        driveUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleProcess();
            }
        });
        
        // S·ª± ki·ªán ƒë√≥ng modal b·∫±ng ph√≠m ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !previewModal.classList.contains('hidden')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
