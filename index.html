<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xem Media Google Drive Cấu Hình Sẵn</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font và giao diện chung -->
    <style>
        :root {
            --primary-color: #EA4335; /* Google Red */
            --secondary-color: #4285F4; /* Google Blue */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            /* Đảm bảo container chính chiếm toàn bộ không gian và căn giữa */
            display: flex; 
            justify-content: center;
            align-items: flex-start;
            padding: 1rem; /* Padding nhỏ cho mobile */
        }
        /* Chỉ giữ lại style cần thiết cho file-box, placeholder, và modal */
        .file-box {
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 150px;
        }
        .file-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        .placeholder {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.875rem;
            text-align: center;
            height: 100px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style cho Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content-wrapper {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        .modal-content-wrapper img, .modal-content-wrapper iframe {
            display: block;
            margin: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        .close-button {
            position: absolute;
            top: -30px;
            right: 0px;
            background: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-start justify-center">

    <!-- KHU VỰC HIỂN THỊ CHÍNH (Chỉ giữ lại resultContainer, đã được làm sạch) -->
    <div id="resultContainer" class="w-full max-w-4xl p-0 md:p-0">
        
        <!-- Khu vực Trạng thái tải (Đã di chuyển lên trên và sửa đổi để tự hiển thị) -->
        <div id="loadingStatus" class="flex items-center justify-center p-2 rounded-lg bg-gray-100 mb-4 mx-auto w-full max-w-sm">
            <div id="loadingSpinner" class="loading-spinner mr-3"></div>
            <span id="buttonText" class="text-gray-700 font-medium">Đang tải nội dung...</span>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-700">Hình ảnh và Video:</h2>
        
        <!-- Khu vực hiển thị lưới file -->
        <div id="fileGrid" 
             class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <!-- Nội dung file sẽ được chèn vào đây bởi JavaScript -->
        </div>
        
        <p id="errorFeedback" class="text-red-500 mt-4 hidden text-center font-medium"></p>
    </div>

    <!-- Modal Xem trước (Lightbox) -->
    <div id="previewModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div id="modalContentWrapper" class="modal-content-wrapper">
            <button class="close-button" onclick="closeModal(event)">&times;</button>
            <div id="previewContent" class="h-full w-full">
                <!-- Nội dung xem trước (Ảnh hoặc Iframe Video) -->
            </div>
        </div>
    </div>

    <!-- Logic JavaScript -->
    <script type="module">
        // ID thư mục Google Drive đã cấu hình sẵn (theo yêu cầu của người dùng)
        const HARDCODED_FOLDER_ID = "1G4B_lmSb4fb3kSMPHPyKPwa3uty9xkiD";

        // Khai báo biến toàn cục (Global variables required by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Thiết lập API Key. BẠN CẦN THAY THẾ CHUỖI NÀY BẰNG API KEY THỰC TẾ CỦA MÌNH.
        const GOOGLE_DRIVE_API_KEY = "AIzaSyC8DDxSNLSupebbcxEitkt279pvHj2ugzA";
        
        // Thời gian chờ giữa các lần tải lại (20 giây)
        const RELOAD_INTERVAL_MS = 20000; 
        let isProcessing = false; // Biến cờ để ngăn tải đè

        // Các phần tử DOM
        const buttonText = document.getElementById('buttonText'); 
        const loadingSpinner = document.getElementById('loadingSpinner'); 
        const resultContainer = document.getElementById('resultContainer');
        const fileGrid = document.getElementById('fileGrid');
        const errorFeedback = document.getElementById('errorFeedback');
        
        // Modal DOM Elements
        const previewModal = document.getElementById('previewModal');
        const previewContent = document.getElementById('previewContent');
        const modalContentWrapper = document.getElementById('modalContentWrapper');


        /**
         * Hiển thị thông báo lỗi.
         * @param {string} message - Thông báo lỗi.
         */
        function displayError(message) {
            // resultContainer không còn bị ẩn, nên chỉ cần cập nhật feedback
            errorFeedback.textContent = message;
            errorFeedback.classList.remove('hidden');
            fileGrid.innerHTML = ''; // Xóa grid cũ
        }

        /**
         * Hiển thị trạng thái tải
         * @param {boolean} isLoading - True để hiển thị, False để ẩn
         */
        function setLoadingState(isLoading) {
            const loadingStatusDiv = document.getElementById('loadingStatus');

            if (isLoading) {
                loadingStatusDiv.classList.remove('hidden');
                buttonText.textContent = 'Đang tải nội dung...';
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingStatusDiv.classList.add('hidden');
            }
        }

        /**
         * Thực hiện lệnh gọi Google Drive API để lấy danh sách file trong thư mục.
         * @param {string} folderId - ID của thư mục Google Drive.
         * @param {string} apiKey - Google Drive API Key.
         * @returns {Array} - Mảng chứa thông tin các file.
         */
        async function fetchFolderContents(folderId, apiKey) {
            // Kiểm tra API Key (vì đã loại bỏ cảnh báo, nên kiểm tra logic này vẫn quan trọng)
            if (apiKey === "YOUR_GOOGLE_DRIVE_API_KEY_HERE" || !apiKey) {
                displayError("Lỗi: Vui lòng thay 'YOUR_GOOGLE_DRIVE_API_KEY_HERE' bằng Google Drive API Key thực tế để truy cập file.");
                return null;
            }

            // Tham số truy vấn: q='folderId' in parents AND trashed=false
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed=false&fields=files(id,name,mimeType)&key=${apiKey}&pageSize=100`;
            
            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `Lỗi API (${response.status}).`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` Chi tiết: ${errorData.error.message}.`;
                    }
                    displayError(errorMessage + " Đảm bảo folder công khai và API Key hợp lệ.");
                    return null;
                }

                const data = await response.json();
                return data.files || [];

            } catch (error) {
                console.error("Lỗi kết nối mạng:", error);
                displayError('Lỗi kết nối mạng hoặc truy vấn API thất bại.');
                return null;
            }
        }
        
        /**
         * Mở modal xem trước với nội dung tương ứng.
         * @param {string} fileId - ID của file.
         * @param {string} mimeType - MIME type của file.
         * @param {string} fileName - Tên file.
         */
        function openPreview(fileId, mimeType, fileName) {
            previewContent.innerHTML = '';
            modalContentWrapper.style.width = 'auto'; 
            modalContentWrapper.style.height = 'auto'; 

            let contentHTML = '';
            const isImage = mimeType.startsWith('image/');
            const isVideo = mimeType.startsWith('video/');

            if (isImage) {
                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                contentHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameborder="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                
                modalContentWrapper.style.width = '90vw'; 
                modalContentWrapper.style.height = '90vh';
                
            } else if (isVideo) {
                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                contentHTML = `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" frameborder="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                modalContentWrapper.style.width = '800px';
                modalContentWrapper.style.height = '450px';

            } else {
                // Mở trong tab mới cho các file không phải ảnh/video (fallback)
                const fileViewUrl = `https://drive.google.com/file/d/${fileId}/view`;
                window.open(fileViewUrl, '_blank'); 
                return; 
            }

            previewContent.innerHTML = contentHTML;
            previewModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        /**
         * Đóng modal xem trước.
         */
        window.closeModal = function(event) {
            if (event && event.target !== previewModal && event.target.className !== 'close-button') {
                if (event.target.closest('#modalContentWrapper') && event.target !== previewModal) return;
            }
            previewModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            previewContent.innerHTML = ''; 
        }
        
        /**
         * Tạo và hiển thị một ô file (thumbnail) trong lưới.
         * @param {Object} file - Đối tượng file từ API.
         */
        function displayFile(file) {
            const isImageOrVideo = file.mimeType.startsWith('image/') || file.mimeType.startsWith('video/');

            // LỌC: Chỉ tiếp tục nếu là Hình ảnh hoặc Video
            if (!isImageOrVideo) {
                return;
            }
            
            // Logic hiển thị chỉ dành cho Media (Image/Video)
            const thumbnailSrc = `https://drive.google.com/thumbnail?id=${file.id}&sz=w150-h150-p`;

            const imgElement = document.createElement('img');
            imgElement.src = thumbnailSrc;
            imgElement.alt = file.name;
            imgElement.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'mx-auto', 'border', 'border-gray-200');
            
            // Xử lý khi thumbnail không tải được (thường xảy ra với video)
            imgElement.onerror = () => {
                const mediaType = file.mimeType.startsWith('image/') ? 'Ảnh' : 'Video';
                imgElement.outerHTML = `<div class="placeholder h-24 rounded-lg">File ${mediaType}</div>`;
            };
            let thumbnailContent = imgElement;


            const fileItem = document.createElement('div');
            fileItem.classList.add('file-box', 'bg-white', 'border', 'border-gray-300', 'rounded-xl', 'p-2', 'text-center', 'flex', 'flex-col', 'justify-between');
            
            const thumbnailWrapper = document.createElement('div');
            thumbnailWrapper.classList.add('mb-2');
            thumbnailWrapper.appendChild(thumbnailContent);
            fileItem.appendChild(thumbnailWrapper);

            const nameElement = document.createElement('p');
            nameElement.textContent = file.name;
            nameElement.classList.add('text-sm', 'font-medium', 'text-gray-800', 'truncate', 'mt-auto');
            fileItem.appendChild(nameElement);

            // Xử lý sự kiện click
            fileItem.onclick = () => {
                // Mở Preview Modal 
                openPreview(file.id, file.mimeType, file.name);
            };

            fileGrid.appendChild(fileItem);
        }

        /**
         * Xử lý khi ứng dụng tự động tải nội dung thư mục.
         * @param {string} folderId - ID thư mục Google Drive đã cấu hình sẵn.
         */
        async function handleProcess(folderId) {
            if (isProcessing) return; // Ngăn chặn tải lại nếu đang trong quá trình tải trước đó
            isProcessing = true;
            
            fileGrid.innerHTML = '';
            errorFeedback.classList.add('hidden');

            setLoadingState(true);
            
            // Thêm độ trễ nhỏ để spinner hiển thị rõ ràng hơn trong quá trình tải lại nhanh
            await new Promise(resolve => setTimeout(resolve, 300)); 

            const files = await fetchFolderContents(folderId, GOOGLE_DRIVE_API_KEY);

            setLoadingState(false);
            isProcessing = false;

            if (files && files.length > 0) {
                errorFeedback.classList.add('hidden');
                files.forEach(displayFile);

                // Nếu không có file media nào được tìm thấy sau khi lọc
                if (fileGrid.children.length === 0) {
                    displayError('Thư mục không chứa bất kỳ file ảnh hoặc video nào được chia sẻ công khai.');
                }
            } else if (files !== null) {
                // Nếu fetchFolderContents trả về null (lỗi API/Key)
                // Lỗi đã được hiển thị bên trong fetchFolderContents
                if (errorFeedback.classList.contains('hidden')) {
                     displayError('Không tìm thấy file nào được chia sẻ công khai trong thư mục.');
                }
            }
        }
        
        // 1. Tự động chạy khi tải trang lần đầu
        handleProcess(HARDCODED_FOLDER_ID);
        
        // 2. Thiết lập hẹn giờ để tải lại sau mỗi 20 giây
        setInterval(() => {
            console.log(`Tự động tải lại nội dung Drive sau ${RELOAD_INTERVAL_MS / 1000} giây...`);
            handleProcess(HARDCODED_FOLDER_ID);
        }, RELOAD_INTERVAL_MS);


        // Sự kiện đóng modal bằng phím ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !previewModal.classList.contains('hidden')) {
                closeModal();
            }
        });
    </script>
</body>
</html>
