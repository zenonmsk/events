<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√¨nh Xem Th∆∞ M·ª•c Google Drive C√¥ng Khai</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- C·∫•u h√¨nh Font v√† giao di·ªán chung -->
    <style>
        :root {
            --primary-color: #EA4335; /* Google Red */
            --secondary-color: #4285F4; /* Google Blue */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .file-box {
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 150px;
        }
        .file-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        .placeholder {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.875rem;
            text-align: center;
            height: 100px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-start justify-center">

    <!-- Th·∫ª ch·ª©a ch√≠nh (Main Container Card) -->
    <div class="container-card w-full max-w-4xl bg-white rounded-xl p-6 md:p-10 mt-10">
        <h1 class="text-3xl font-bold text-center mb-6 text-[var(--primary-color)]">
            Tr√¨nh Xem Th∆∞ M·ª•c Google Drive C√¥ng Khai
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Nh·∫≠p li√™n k·∫øt chia s·∫ª c√¥ng khai (Public Viewer) c·ªßa th∆∞ m·ª•c t·ª´ Google Drive.
        </p>

        <!-- Khu v·ª±c Nh·∫≠p li·ªáu -->
        <div class="space-y-4">
            <input type="text" id="driveUrlInput" placeholder="D√°n link Google Drive Folder (v√≠ d·ª•: https://drive.google.com/drive/folders/FOLDER_ID)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--secondary-color)] focus:border-[var(--secondary-color)]">
            
            <button id="processButton"
                    class="w-full bg-[var(--secondary-color)] text-white font-semibold py-3 rounded-lg hover:bg-opacity-90 transition duration-150 shadow-md flex items-center justify-center">
                <span id="buttonText">L·∫•y N·ªôi Dung Th∆∞ M·ª•c</span>
                <div id="loadingSpinner" class="loading-spinner ml-3 hidden"></div>
            </button>
        </div>

        <!-- Khu v·ª±c Hi·ªÉn th·ªã K·∫øt qu·∫£ -->
        <div id="resultContainer" class="mt-10 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">C√°c File trong Th∆∞ m·ª•c:</h2>
            
            <p id="apiKeyWarning" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-md text-sm">
                ‚ö†Ô∏è **C·∫ßn API Key:** B·∫°n ph·∫£i thay `YOUR_GOOGLE_DRIVE_API_KEY_HERE` trong m√£ JS b·∫±ng Google Drive API Key th·ª±c t·∫ø c·ªßa b·∫°n ƒë·ªÉ ch·ª©c nƒÉng n√†y ho·∫°t ƒë·ªông.
            </p>

            <div id="fileGrid" 
                 class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- N·ªôi dung file s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·ªüi JavaScript -->
            </div>
            
            <p id="errorFeedback" class="text-red-500 mt-4 hidden text-center font-medium"></p>
        </div>

    </div>

    <!-- Logic JavaScript -->
    <script type="module">
        // Khai b√°o bi·∫øn to√†n c·ª•c (Global variables required by the environment)
        // L∆∞u √Ω: C√°c bi·∫øn n√†y kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng ·ªü ƒë√¢y nh∆∞ng c·∫ßn thi·∫øt cho m√¥i tr∆∞·ªùng
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Thi·∫øt l·∫≠p API Key. B·∫†N C·∫¶N THAY TH·∫æ CHU·ªñI N√ÄY B·∫∞NG API KEY TH·ª∞C T·∫æ C·ª¶A M√åNH.
        const GOOGLE_DRIVE_API_KEY = "AIzaSyC8DDxSNLSupebbcxEitkt279pvHj2ugzA";

        // C√°c ph·∫ßn t·ª≠ DOM
        const driveUrlInput = document.getElementById('driveUrlInput');
        const processButton = document.getElementById('processButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultContainer = document.getElementById('resultContainer');
        const fileGrid = document.getElementById('fileGrid');
        const errorFeedback = document.getElementById('errorFeedback');
        const apiKeyWarning = document.getElementById('apiKeyWarning');

        /**
         * Tr√≠ch xu·∫•t ID t·ª´ URL Google Drive (h·ª£p l·ªá cho c·∫£ File v√† Folder).
         * @param {string} url - URL Google Drive
         * @returns {string|null} - ID File/Folder ho·∫∑c null n·∫øu kh√¥ng t√¨m th·∫•y
         */
        function extractId(url) {
            // Regex t√¨m chu·ªói ID d√†i (th∆∞·ªùng l√† 25-40 k√Ω t·ª±)
            const regex = /[-\w]{25,}/; 
            const match = url.match(regex);
            
            if (match) {
                return match[0];
            }
            return null;
        }

        /**
         * Hi·ªÉn th·ªã th√¥ng b√°o l·ªói.
         * @param {string} message - Th√¥ng b√°o l·ªói.
         */
        function displayError(message) {
            resultContainer.classList.remove('hidden');
            errorFeedback.textContent = message;
            errorFeedback.classList.remove('hidden');
            fileGrid.innerHTML = ''; // X√≥a grid c≈©
        }

        /**
         * Hi·ªÉn th·ªã tr·∫°ng th√°i t·∫£i
         * @param {boolean} isLoading - True ƒë·ªÉ hi·ªÉn th·ªã, False ƒë·ªÉ ·∫©n
         */
        function setLoadingState(isLoading) {
            processButton.disabled = isLoading;
            if (isLoading) {
                buttonText.textContent = 'ƒêang t·∫£i...';
                loadingSpinner.classList.remove('hidden');
            } else {
                buttonText.textContent = 'L·∫•y N·ªôi Dung Th∆∞ M·ª•c';
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Th·ª±c hi·ªán l·ªánh g·ªçi Google Drive API ƒë·ªÉ l·∫•y danh s√°ch file trong th∆∞ m·ª•c.
         * @param {string} folderId - ID c·ªßa th∆∞ m·ª•c Google Drive.
         * @param {string} apiKey - Google Drive API Key.
         * @returns {Array} - M·∫£ng ch·ª©a th√¥ng tin c√°c file.
         */
        async function fetchFolderContents(folderId, apiKey) {
            if (apiKey === "YOUR_GOOGLE_DRIVE_API_KEY_HERE" || !apiKey) {
                displayError("L·ªói: Vui l√≤ng thay 'YOUR_GOOGLE_DRIVE_API_KEY_HERE' b·∫±ng Google Drive API Key th·ª±c t·∫ø.");
                return null;
            }

            // Tham s·ªë truy v·∫•n:
            // q='folderId' in parents AND trashed=false (Ch·ªâ l·∫•y file trong folder n√†y v√† kh√¥ng b·ªã x√≥a)
            // fields=files(id, name, mimeType) (Ch·ªâ l·∫•y c√°c tr∆∞·ªùng c·∫ßn thi·∫øt)
            // pageSize=100 (S·ªë l∆∞·ª£ng file t·ªëi ƒëa, c√≥ th·ªÉ c·∫ßn ph√¢n trang n·∫øu th∆∞ m·ª•c qu√° l·ªõn)
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed=false&fields=files(id,name,mimeType)&key=${apiKey}&pageSize=100`;
            
            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `L·ªói API (${response.status}).`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` Chi ti·∫øt: ${errorData.error.message}.`;
                    }
                    // Th∆∞·ªùng l·ªói 403 (Permission Denied) n·∫øu folder kh√¥ng c√¥ng khai ho·∫∑c API Key sai
                    displayError(errorMessage + " ƒê·∫£m b·∫£o folder c√¥ng khai v√† API Key h·ª£p l·ªá.");
                    return null;
                }

                const data = await response.json();
                return data.files || [];

            } catch (error) {
                console.error("L·ªói k·∫øt n·ªëi m·∫°ng:", error);
                displayError('L·ªói k·∫øt n·ªëi m·∫°ng ho·∫∑c truy v·∫•n API th·∫•t b·∫°i.');
                return null;
            }
        }
        
        /**
         * T·∫°o v√† hi·ªÉn th·ªã m·ªôt √¥ file (thumbnail) trong l∆∞·ªõi.
         * @param {Object} file - ƒê·ªëi t∆∞·ª£ng file t·ª´ API.
         */
        function displayFile(file) {
            // M·∫∑c ƒë·ªãnh cho file kh√¥ng ph·∫£i ·∫£nh/video ho·∫∑c khi kh√¥ng c√≥ thumbnail
            let thumbnailContent;
            const fileViewUrl = `https://drive.google.com/file/d/${file.id}/view`;
            const isImageOrVideo = file.mimeType.startsWith('image/') || file.mimeType.startsWith('video/');

            if (isImageOrVideo) {
                // S·ª≠ d·ª•ng thumbnail API cho ·∫£nh/video
                const thumbnailSrc = `https://drive.google.com/thumbnail?id=${file.id}&sz=w150-h150-p`;

                const imgElement = document.createElement('img');
                imgElement.src = thumbnailSrc;
                imgElement.alt = file.name;
                imgElement.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'mx-auto', 'border', 'border-gray-200');
                
                // Fallback n·∫øu thumbnail kh√¥ng t·∫£i ƒë∆∞·ª£c (v√≠ d·ª•: file video l·ªõn)
                imgElement.onerror = () => {
                    imgElement.outerHTML = `<div class="placeholder h-24 rounded-lg">File ƒëa ph∆∞∆°ng ti·ªán</div>`;
                };
                thumbnailContent = imgElement;
            } else {
                // Icon placeholder cho c√°c lo·∫°i file kh√°c (v√≠ d·ª•: t√†i li·ªáu, zip)
                const icon = file.mimeType.includes('pdf') ? 'üìÑ' : 
                             file.mimeType.includes('document') ? 'üìù' : 
                             file.mimeType.includes('spreadsheet') ? 'üìä' : 
                             file.mimeType.includes('folder') ? 'üìÅ' : 'üì¶';
                
                thumbnailContent = document.createElement('div');
                thumbnailContent.classList.add('placeholder', 'h-24', 'rounded-lg');
                thumbnailContent.innerHTML = `<span class="text-3xl">${icon}</span><br><span class="text-xs">(${file.mimeType.split('/').pop()})</span>`;
            }

            // T·∫°o container cho m·ªói file
            const fileItem = document.createElement('div');
            fileItem.classList.add('file-box', 'bg-white', 'border', 'border-gray-300', 'rounded-xl', 'p-2', 'text-center', 'flex', 'flex-col', 'justify-between');
            
            // Container cho thumbnail/icon
            const thumbnailWrapper = document.createElement('div');
            thumbnailWrapper.classList.add('mb-2');
            thumbnailWrapper.appendChild(thumbnailContent);
            fileItem.appendChild(thumbnailWrapper);

            // T√™n file
            const nameElement = document.createElement('p');
            nameElement.textContent = file.name;
            nameElement.classList.add('text-sm', 'font-medium', 'text-gray-800', 'truncate', 'mt-auto');
            fileItem.appendChild(nameElement);

            // S·ª± ki·ªán click: m·ªü file tr√™n tab hi·ªán t·∫°i
            fileItem.onclick = () => {
                window.location.href = fileViewUrl;
            };

            fileGrid.appendChild(fileItem);
        }

        /**
         * X·ª≠ l√Ω khi ng∆∞·ªùi d√πng nh·∫•p v√†o n√∫t "L·∫•y N·ªôi Dung Th∆∞ M·ª•c".
         */
        async function handleProcess() {
            const url = driveUrlInput.value.trim();
            fileGrid.innerHTML = '';
            errorFeedback.classList.add('hidden');
            resultContainer.classList.add('hidden');
            apiKeyWarning.classList.remove('hidden'); // Lu√¥n hi·ªÉn th·ªã c·∫£nh b√°o API Key

            if (!url) {
                displayError('Vui l√≤ng nh·∫≠p m·ªôt li√™n k·∫øt Google Drive Folder.');
                return;
            }

            const folderId = extractId(url);

            if (!folderId) {
                displayError('Kh√¥ng t√¨m th·∫•y ID th∆∞ m·ª•c h·ª£p l·ªá trong li√™n k·∫øt. Vui l√≤ng ki·ªÉm tra l·∫°i li√™n k·∫øt chia s·∫ª.');
                return;
            }

            setLoadingState(true);
            resultContainer.classList.remove('hidden');

            const files = await fetchFolderContents(folderId, GOOGLE_DRIVE_API_KEY);

            setLoadingState(false);

            if (files && files.length > 0) {
                // ·∫®n th√¥ng b√°o l·ªói n·∫øu th√†nh c√¥ng
                errorFeedback.classList.add('hidden');
                
                // L·∫∑p qua danh s√°ch file v√† hi·ªÉn th·ªã
                files.forEach(displayFile);
            } else if (files !== null) {
                // N·∫øu fetchFolderContents tr·∫£ v·ªÅ m·∫£ng r·ªóng (kh√°c null)
                displayError('Th∆∞ m·ª•c r·ªóng ho·∫∑c kh√¥ng t√¨m th·∫•y file n√†o ƒë∆∞·ª£c chia s·∫ª c√¥ng khai.');
            }
        }

        // G√°n s·ª± ki·ªán cho n√∫t
        processButton.addEventListener('click', handleProcess);

        // Cho ph√©p nh·∫•n Enter trong √¥ input ƒë·ªÉ x·ª≠ l√Ω
        driveUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleProcess();
            }
        });
    </script>
</body>
</html>
