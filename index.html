<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Xem Media Google Drive Cấu Hình Sẵn</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cấu hình Font và giao diện chung -->
    <style>
        :root {
            --primary-color: #EA4335; /* Google Red */
            --secondary-color: #4285F4; /* Google Blue */
            --refresh-color: #34A853; /* Google Green */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            /* Đảm bảo container chính chiếm toàn bộ không gian và căn giữa */
            display: flex; 
            justify-content: center;
            align-items: flex-start;
            padding: 1rem; /* Padding nhỏ cho mobile */
        }
        /* Chỉ giữ lại style cần thiết cho file-box, placeholder, và modal */
        .file-box {
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 150px;
        }
        .file-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }
        .placeholder {
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.875rem;
            text-align: center;
            height: 100px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style cho Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-content-wrapper {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        .modal-content-wrapper img, .modal-content-wrapper iframe {
            display: block;
            margin: auto;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        .close-button {
            position: absolute;
            top: -30px;
            right: 0px;
            background: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }
        /* Nút Tải xuống trong Modal */
        #downloadButton {
            position: absolute;
            top: -30px;
            right: 48px; /* Dịch sang trái 48px để không trùng Close button */
            color: white;
            font-size: 2rem;
            padding: 4px;
            border-radius: 50%;
            transition: color 0.2s, transform 0.2s;
            line-height: 1;
        }
        #downloadButton:hover {
            color: #ccc;
            transform: scale(1.1);
        }
        .refresh-button {
            background-color: var(--refresh-color);
            transition: background-color 0.2s;
        }
        .refresh-button:hover:not(:disabled) {
            background-color: #2c9747;
        }
        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .pagination-button {
            background-color: var(--secondary-color);
            transition: background-color 0.2s;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: #3c78e3;
        }
        .pagination-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-start justify-center">

    <!-- KHU VỰC HIỂN THỊ CHÍNH -->
    <div id="resultContainer" class="w-full max-w-4xl p-0 md:p-0">
        
        <!-- Khu vực Trạng thái và Nút Refresh -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
            <!-- Nút Refresh -->
            <button id="refreshButton" class="refresh-button text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-[var(--refresh-color)] focus:ring-opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline mr-2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181-3.181m1.479 9.348l3.181-3.181m0-2.288l4.243-4.243m-8.484 0L3.06 14.69M4.318 6.318A7.74 7.74 0 0110.23 3.784c5.008-.617 9.497 1.84 11.44 6.953m-13.483 1.077H13.8V9.75M6.51 17.653l-.86-2.58A7.74 7.74 0 0113.77 20.216c5.008.617 9.497-1.84 11.44-6.953" />
                </svg>
                Làm Mới
            </button>
            
            <!-- Trạng thái tải -->
            <div id="loadingStatus" class="flex items-center justify-center p-2 rounded-lg bg-gray-100 w-full sm:w-auto">
                <div id="loadingSpinner" class="loading-spinner mr-3 hidden"></div>
                <span id="buttonText" class="text-gray-700 font-medium">Sẵn sàng.</span>
            </div>
        </div>

        <h2 class="text-xl font-semibold mb-4 text-gray-700">Hình ảnh và Video:</h2>
        
        <!-- Khu vực hiển thị lưới file -->
        <div id="fileGrid" 
             class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            <!-- Nội dung file sẽ được chèn vào đây bởi JavaScript -->
        </div>

        <!-- Khu vực Phân trang -->
        <div id="paginationControls" class="flex justify-center items-center mt-6 p-4 rounded-lg bg-white shadow-inner border border-gray-200 hidden">
            <button id="prevButton" onclick="prevPage()" class="pagination-button text-white font-semibold py-2 px-4 rounded-l-lg disabled:opacity-50">
                Trang Trước
            </button>
            
            <span id="pageInfo" class="mx-4 text-gray-700 font-medium w-32 text-center">
                Trang 1 / 1
            </span>

            <button id="nextButton" onclick="nextPage()" class="pagination-button text-white font-semibold py-2 px-4 rounded-r-lg disabled:opacity-50">
                Trang Sau
            </button>
        </div>
        
        <p id="errorFeedback" class="text-red-500 mt-4 hidden text-center font-medium"></p>
    </div>

    <!-- Modal Xem trước (Lightbox) -->
    <div id="previewModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div id="modalContentWrapper" class="modal-content-wrapper">
            <!-- Nút Tải Xuống (chỉ hiển thị cho ảnh) -->
            <!-- <a id="downloadButton" href="#" download class="hidden text-white p-1 rounded-full hover:text-gray-300 transition-colors" title="Tải xuống ảnh này">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
            </a> -->
            <button class="close-button" onclick="closeModal(event)">&times;</button>
            <div id="previewContent" class="h-full w-full">
                <!-- Nội dung xem trước (Ảnh hoặc Iframe Video) -->
            </div>
        </div>
    </div>

    <!-- Logic JavaScript -->
    <script type="module">
        // ID thư mục Google Drive đã cấu hình sẵn (theo yêu cầu của người dùng)
        const HARDCODED_FOLDER_ID = "1G4B_lmSb4fb3kSMPHPyKPwa3uty9xkiD";

        // Khai báo biến toàn cục (Global variables required by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Thiết lập API Key. BẠN CẦN THAY THẾ CHUỖI NÀY BẰNG API KEY THỰC TẾ CỦA MÌNH.
        const GOOGLE_DRIVE_API_KEY = "AIzaSyC8DDxSNLSupebbcxEitkt279pvHj2ugzA";
        
        // Cấu hình Phân trang và Tải lại
        const RELOAD_INTERVAL_MS = 20000; // 20 giây
        const FILES_PER_PAGE = 8; // Số file hiển thị trên mỗi trang

        // Biến trạng thái
        let isProcessing = false; 
        let currentPage = 1;
        let allFiles = []; // Mảng chứa tất cả các file đã tải

        // Các phần tử DOM
        const buttonText = document.getElementById('buttonText'); 
        const loadingSpinner = document.getElementById('loadingSpinner'); 
        const fileGrid = document.getElementById('fileGrid');
        const errorFeedback = document.getElementById('errorFeedback');
        const refreshButton = document.getElementById('refreshButton');
        
        // Phần tử Phân trang
        const paginationControls = document.getElementById('paginationControls');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const pageInfo = document.getElementById('pageInfo');
        
        // Modal DOM Elements
        const previewModal = document.getElementById('previewModal');
        const previewContent = document.getElementById('previewContent');
        const modalContentWrapper = document.getElementById('modalContentWrapper');
        // const downloadButton = document.getElementById('downloadButton'); // Nút Tải xuống

        /**
         * Hiển thị thông báo lỗi.
         * @param {string} message - Thông báo lỗi.
         */
        function displayError(message) {
            errorFeedback.textContent = message;
            errorFeedback.classList.remove('hidden');
            fileGrid.innerHTML = ''; 
        }

        /**
         * Hiển thị trạng thái tải.
         * @param {boolean} isLoading - True để hiển thị, False để ẩn.
         */
        function setLoadingState(isLoading) {
            const loadingStatusDiv = document.getElementById('loadingStatus');

            if (isLoading) {
                loadingStatusDiv.classList.remove('hidden');
                buttonText.textContent = 'Đang tải nội dung...';
                loadingSpinner.classList.remove('hidden');
                refreshButton.disabled = true;
            } else {
                loadingStatusDiv.classList.add('hidden');
                buttonText.textContent = 'Sẵn sàng.';
                loadingSpinner.classList.add('hidden');
                refreshButton.disabled = false;
            }
        }
        
        /**
         * Cập nhật giao diện phân trang.
         */
        function setupPagination() {
            const totalPages = Math.ceil(allFiles.length / FILES_PER_PAGE);
            const hasFiles = allFiles.length > 0;

            if (hasFiles) {
                pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages;
                paginationControls.classList.remove('hidden');
            } else {
                pageInfo.textContent = '0 file media.';
                prevButton.disabled = true;
                nextButton.disabled = true;
                paginationControls.classList.add('hidden');
            }
        }

        /**
         * Chuyển đến trang tiếp theo.
         */
        window.nextPage = function() {
            const totalPages = Math.ceil(allFiles.length / FILES_PER_PAGE);
            if (currentPage < totalPages) {
                currentPage++;
                renderFiles();
            }
        }

        /**
         * Chuyển về trang trước.
         */
        window.prevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                renderFiles();
            }
        }

        /**
         * Render các file trong trang hiện tại.
         */
        function renderFiles() {
            // Tính toán vị trí slice
            const startIndex = (currentPage - 1) * FILES_PER_PAGE;
            const endIndex = startIndex + FILES_PER_PAGE;
            const filesToDisplay = allFiles.slice(startIndex, endIndex);

            // Xóa và Render
            fileGrid.innerHTML = '';
            filesToDisplay.forEach(displayFile);

            // Cập nhật UI phân trang
            setupPagination();
        }

        /**
         * Thực hiện lệnh gọi Google Drive API để lấy danh sách file trong thư mục.
         * @param {string} folderId - ID của thư mục Google Drive.
         * @param {string} apiKey - Google Drive API Key.
         * @returns {Array} - Mảng chứa thông tin các file.
         */
        async function fetchFolderContents(folderId, apiKey) {
            if (apiKey === "YOUR_GOOGLE_DRIVE_API_KEY_HERE" || !apiKey) {
                displayError("Lỗi: Vui lòng thay 'YOUR_GOOGLE_DRIVE_API_KEY_HERE' bằng Google Drive API Key thực tế để truy cập file.");
                return null;
            }

            // Thêm tham số orderBy=createdTime desc để sắp xếp theo thời gian tạo (upload) giảm dần
            const apiUrl = `https://www.googleapis.com/drive/v3/files?q='${folderId}' in parents and trashed=false&fields=files(id,name,mimeType)&key=${apiKey}&pageSize=100&orderBy=createdTime desc`;
            
            try {
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `Lỗi API (${response.status}).`;
                    if (errorData.error && errorData.error.message) {
                        errorMessage += ` Chi tiết: ${errorData.error.message}.`;
                    }
                    displayError(errorMessage + " Đảm bảo folder công khai và API Key hợp lệ.");
                    return null;
                }

                const data = await response.json();
                return data.files || [];

            } catch (error) {
                console.error("Lỗi kết nối mạng:", error);
                displayError('Lỗi kết nối mạng hoặc truy vấn API thất bại.');
                return null;
            }
        }
        
        /**
         * Mở modal xem trước với nội dung tương ứng.
         * @param {string} fileId - ID của file.
         * @param {string} mimeType - MIME type của file.
         * @param {string} fileName - Tên file.
         */
        function openPreview(fileId, mimeType, fileName) {
            previewContent.innerHTML = '';
            modalContentWrapper.style.width = 'auto'; 
            modalContentWrapper.style.height = 'auto'; 
            
            // Ẩn nút download mặc định
            // downloadButton.classList.add('hidden');

            let contentHTML = '';
            const isImage = mimeType.startsWith('image/');
            const isVideo = mimeType.startsWith('video/');

            if (isImage) {
                const embedUrl = `https://drive.google.com/file/d/${fileId}/embed`;
                // Dùng iframe để xem trước ảnh
                contentHTML = `<iframe src="${embedUrl}" width="100%" height="100%" frameborder="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                
                modalContentWrapper.style.width = '90vw'; 
                modalContentWrapper.style.height = '90vh';
                
                // Hiển thị và cấu hình nút download cho ảnh
                // const downloadUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                // downloadButton.href = downloadUrl;
                // downloadButton.download = fileName; // Gợi ý tên file khi tải về
                // downloadButton.classList.remove('hidden');

            } else if (isVideo) {
                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;
                // Dùng iframe để xem trước video
                contentHTML = `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" frameborder="0" allowfullscreen class="rounded-lg shadow-2xl"></iframe>`;
                modalContentWrapper.style.width = '800px';
                modalContentWrapper.style.height = '450px';

            } else {
                // Mở trong tab mới cho các file không phải ảnh/video (fallback)
                const fileViewUrl = `https://drive.google.com/file/d/${fileId}/view`;
                window.open(fileViewUrl, '_blank'); 
                return; 
            }

            previewContent.innerHTML = contentHTML;
            previewModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        /**
         * Đóng modal xem trước.
         */
        window.closeModal = function(event) {
            // Kiểm tra để chỉ đóng khi click vào overlay hoặc nút đóng
            if (event && event.target !== previewModal && event.target.className !== 'close-button') {
                if (event.target.closest('#modalContentWrapper') && event.target !== previewModal && event.target !== downloadButton) return;
            }
            previewModal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            previewContent.innerHTML = ''; 
            // downloadButton.classList.add('hidden'); // Đảm bảo nút download bị ẩn khi đóng
        }
        
        /**
         * Tạo và hiển thị một ô file (thumbnail) trong lưới.
         * @param {Object} file - Đối tượng file từ API.
         */
        function displayFile(file) {
            const isImageOrVideo = file.mimeType.startsWith('image/') || file.mimeType.startsWith('video/');

            if (!isImageOrVideo) {
                return;
            }
            
            const thumbnailSrc = `https://drive.google.com/thumbnail?id=${file.id}&sz=w150-h150-p`;

            const imgElement = document.createElement('img');
            imgElement.src = thumbnailSrc;
            imgElement.alt = file.name;
            imgElement.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'mx-auto', 'border', 'border-gray-200');
            
            imgElement.onerror = () => {
                const mediaType = file.mimeType.startsWith('image/') ? 'Ảnh' : 'Video';
                imgElement.outerHTML = `<div class="placeholder h-24 rounded-lg">File ${mediaType}</div>`;
            };
            let thumbnailContent = imgElement;


            const fileItem = document.createElement('div');
            fileItem.classList.add('file-box', 'bg-white', 'border', 'border-gray-300', 'rounded-xl', 'p-2', 'text-center', 'flex', 'flex-col', 'justify-between');
            
            const thumbnailWrapper = document.createElement('div');
            thumbnailWrapper.classList.add('mb-2');
            thumbnailWrapper.appendChild(thumbnailContent);
            fileItem.appendChild(thumbnailWrapper);

            const nameElement = document.createElement('p');
            nameElement.textContent = file.name;
            nameElement.classList.add('text-sm', 'font-medium', 'text-gray-800', 'truncate', 'mt-auto');
            fileItem.appendChild(nameElement);

            fileItem.onclick = () => {
                openPreview(file.id, file.mimeType, file.name);
            };

            fileGrid.appendChild(fileItem);
        }

        /**
         * Xử lý khi ứng dụng tự động tải nội dung thư mục.
         * @param {string} folderId - ID thư mục Google Drive đã cấu hình sẵn.
         */
        async function handleProcess(folderId, resetPage = true) {
            if (isProcessing) return; 
            isProcessing = true;
            
            errorFeedback.classList.add('hidden');
            setLoadingState(true);
            
            await new Promise(resolve => setTimeout(resolve, 300)); 

            const files = await fetchFolderContents(folderId, GOOGLE_DRIVE_API_KEY);

            if (files !== null) {
                // Lọc chỉ giữ lại file media
                allFiles = files.filter(file => file.mimeType.startsWith('image/') || file.mimeType.startsWith('video/'));

                if (resetPage) {
                    currentPage = 1; // Luôn quay về trang 1 khi tải lại toàn bộ dữ liệu
                }
                
                if (allFiles.length > 0) {
                    renderFiles();
                } else {
                    fileGrid.innerHTML = '';
                    displayError('Thư mục không chứa bất kỳ file ảnh hoặc video nào được chia sẻ công khai.');
                    setupPagination(); // Cập nhật UI phân trang (ẩn đi)
                }
            } else {
                allFiles = [];
                setupPagination(); // Cập nhật UI phân trang (ẩn đi)
            }

            setLoadingState(false);
            isProcessing = false;
        }
        
        // Gắn sự kiện cho nút Refresh
        refreshButton.addEventListener('click', () => {
            console.log("Làm mới thủ công...");
            handleProcess(HARDCODED_FOLDER_ID, true); // true để reset về trang 1
        });

        // 1. Tự động chạy khi tải trang lần đầu
        handleProcess(HARDCODED_FOLDER_ID, true);
        
        // 2. Thiết lập hẹn giờ để tải lại sau mỗi 20 giây (không reset trang nếu người dùng đang xem trang > 1)
        setInterval(() => {
            console.log(`Tự động tải lại nội dung Drive sau ${RELOAD_INTERVAL_MS / 1000} giây...`);
            // Giữ nguyên trang hiện tại, chỉ thay đổi nội dung nếu có file mới
            handleProcess(HARDCODED_FOLDER_ID, false); 
        }, RELOAD_INTERVAL_MS);


        // Sự kiện đóng modal bằng phím ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !previewModal.classList.contains('hidden')) {
                closeModal();
            }
        });
    </script>
</body>
</html>

